image: ruby:2.3

cache:
  key: vendor
  paths:
    - vendor

before_script:
  - export GEM_HOME=vendor/`ruby -e 'puts [Gem.ruby_engine, Gem.ruby_api_version].join("/")'`

stages:
  - prepare
  - test
  - gem:build
  - gem:release

prepare:
  stage: prepare
  script:
    - which bundler || gem install bundler --no-ri --no-rdoc
    - bundle install --path vendor

info:
  stage: test
  script:
    - uname -a
    - whoami
    - pwd
    - ruby -v
    - which ruby
    - gem env
    - gem list
    - ls -al

test:
  stage: test
  script:
    - rake test

gem:build:
  stage: gem:build
  script:
    - rake gem:build
  artifacts:
    paths:
      - pkg/

gem:release:
  when: manual
  stage: gem:release
  script:
    - git status
    - rake gem:release
